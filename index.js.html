const express = require('express')
const bodyParser = require('body-parser')
const request = require('request')

const APP_TOKEN = 'EAATCGQ6pAngBAHnNTr5OcyaXMJjgPDfjnExgo8iTByKs1GWTCas2p0p8JujvOk9FdI03uBkY62eOkc9ADatDEhdQnkd9oSg8aumw5GKUNMVtbBf6aRheadOJ37EWBHZBHhzpFVv771i9fYIkjKnUHLIZB2fYVgHwObZBGbHYAZDZD'

var app = express()

app.use(bodyParser.json())

app.listen(3000,function(){
	console.log('Server listen localhost:3000')
})

app.get('/',function(req, res){
	res.send('abriendo el puerto desde mi pc local con http: ngrok.com')
})

app.get('/webhook', function(req, res){
	if(req.query['hub.verify_token']='hello_token'){
		res.send(req.query['hub.challenge'])
	}else{
		res.send('tu no puedes entrar xd')
	}
	
})

app.post('/webhook', function(req, res){
	var data = req.body
	if(data.object == 'page'){
		data.entry.forEach(function(pageEntry){
			pageEntry.messaging.forEach(function(messagingEvent){
				if(messagingEvent.message){
					var senderID = messagingEvent.sender.id
					var messageText = messagingEvent.message.text

					var messageData = {
						recipient : {
							id: senderID
						},
						message:{
							text: 'Solo se repetir :c :'+ messageText
						}
					}
					//api facebook
					request({
						uri:'https://graph.facebook.com/v2.6/me/messages',
						qs: {access_token: APP_TOKEN},
						method: 'POST',
						json: messageData
					}, function(error, response, data){
						if(error)
							console.log('No es posible enviar el mensaje')
						else
							console.log('Mensaje enviado')
					})
				}
			})
		})
	}
	res.sendStatus(200)
})
